name: Validate Docker Stacks

on:
  push:
    branches: [ main ]
    paths:
      - 'stacks/**'
      - '.github/workflows/validate-stacks.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'stacks/**'

jobs:
  validate-compose-files:
    name: Validate Docker Compose Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Find all docker-compose files
        id: find-compose
        run: |
          echo "Finding all docker-compose.yml files..."
          find stacks -name "docker-compose.yml" -type f > compose-files.txt
          cat compose-files.txt

      - name: Validate each compose file
        run: |
          echo "Validating Docker Compose syntax..."
          while IFS= read -r compose_file; do
            echo "\n=== Validating: $compose_file ==="
            if docker compose -f "$compose_file" config > /dev/null 2>&1; then
              echo "✅ Valid: $compose_file"
            else
              echo "❌ Invalid: $compose_file"
              docker compose -f "$compose_file" config
              exit 1
            fi
          done < compose-files.txt

  validate-env-examples:
    name: Validate .env.example Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check .env.example exists for each stack
        run: |
          echo "Checking if each stack has .env.example..."
          missing_env_files=""
          
          for stack_dir in stacks/*/; do
            stack_name=$(basename "$stack_dir")
            
            # Skip if it's not a directory or is just README
            if [ ! -d "$stack_dir" ] || [ "$stack_name" = "README.md" ]; then
              continue
            fi
            
            # Check if docker-compose.yml exists
            if [ ! -f "${stack_dir}docker-compose.yml" ]; then
              echo "⚠️  Skipping $stack_name (no docker-compose.yml)"
              continue
            fi
            
            # Check if .env.example exists
            if [ ! -f "${stack_dir}.env.example" ]; then
              echo "❌ Missing .env.example in: $stack_name"
              missing_env_files="${missing_env_files}${stack_name}\n"
            else
              echo "✅ Found .env.example in: $stack_name"
            fi
          done
          
          if [ -n "$missing_env_files" ]; then
            echo -e "\n⚠️  The following stacks are missing .env.example files:"
            echo -e "$missing_env_files"
            exit 1
          fi
          
          echo -e "\n✅ All stacks have .env.example files!"

      - name: Validate .env.example variables match compose files
        run: |
          echo "Checking if variables in .env.example match docker-compose.yml..."
          validation_errors=""
          
          for stack_dir in stacks/*/; do
            stack_name=$(basename "$stack_dir")
            compose_file="${stack_dir}docker-compose.yml"
            env_file="${stack_dir}.env.example"
            
            # Skip if files don't exist
            if [ ! -f "$compose_file" ] || [ ! -f "$env_file" ]; then
              continue
            fi
            
            echo "\n=== Checking $stack_name ==="
            
            # Extract variables from docker-compose.yml (${VAR} or $VAR format)
            compose_vars=$(grep -oE '\$\{?[A-Z_][A-Z0-9_]*\}?' "$compose_file" | \
                          sed 's/[${}]//g' | sort -u)
            
            # Extract variables from .env.example (VAR=value format)
            env_vars=$(grep -v '^#' "$env_file" | grep -v '^$' | cut -d'=' -f1 | sort -u)
            
            # Check if compose variables exist in .env.example
            for var in $compose_vars; do
              if ! echo "$env_vars" | grep -q "^${var}$"; then
                echo "⚠️  Variable \$${var} used in docker-compose.yml but missing in .env.example"
                validation_errors="${validation_errors}[${stack_name}] Missing variable: ${var}\n"
              fi
            done
          done
          
          if [ -n "$validation_errors" ]; then
            echo -e "\n❌ Validation errors found:"
            echo -e "$validation_errors"
            echo -e "\nPlease ensure all variables used in docker-compose.yml are defined in .env.example"
            exit 1
          fi
          
          echo -e "\n✅ All .env.example files are consistent with their docker-compose.yml!"

  validate-readme-exists:
    name: Validate README Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README.md exists for each stack
        run: |
          echo "Checking if each stack has README.md..."
          missing_readme=""
          
          for stack_dir in stacks/*/; do
            stack_name=$(basename "$stack_dir")
            
            # Skip if it's not a directory
            if [ ! -d "$stack_dir" ]; then
              continue
            fi
            
            # Check if docker-compose.yml exists
            if [ ! -f "${stack_dir}docker-compose.yml" ]; then
              continue
            fi
            
            # Check if README.md exists
            if [ ! -f "${stack_dir}README.md" ]; then
              echo "❌ Missing README.md in: $stack_name"
              missing_readme="${missing_readme}${stack_name}\n"
            else
              echo "✅ Found README.md in: $stack_name"
            fi
          done
          
          if [ -n "$missing_readme" ]; then
            echo -e "\n⚠️  The following stacks are missing README.md files:"
            echo -e "$missing_readme"
            exit 1
          fi
          
          echo -e "\n✅ All stacks have README.md files!"
